# CS-546 Lab 7

## Animal Farm 2

For this lab, we are going to make **more** parts of the database for a social media website for animals, as well as developing a simple API to interact with your application.

We will be practicing:

- Seperating concerns into different modules:
  - Database connection in one module
  - Collections defined in another
  - Data manipulation in another
- Practicing the usage of **async / await** for asynchronous code
- Continuing our exercises of linking these modules together as needed
- Developing a simple (12 route) API server

## Packages you will use:

You will use the [mongodb](https://mongodb.github.io/node-mongodb-native/) package to hook into MongoDB

You may use the [lecture 4 code](https://github.com/Stevens-CS546/CS-546/tree/master/Lecture%20Code/lecture_04) and the [lecture 6 code](https://github.com/Stevens-CS546/CS-546/tree/master/Lecture%20Code/lecture_06) and [lecture 7 code](https://github.com/Stevens-CS546/CS-546/tree/master/Lecture%20Code/lecture_07) as a guide.

You can read up on [express](http://expressjs.com/) on its home page. Specifically, you may find the [API Guide section on requests](http://expressjs.com/en/4x/api.html#req) useful.

**You must save all dependencies you use to your package.json file**

## Folder Structure

You will use the following folder structure for the data module. **You may need other files to handle the connection to the database as well.**

```
./
../data/
../data/animals.js
../data/index.js
../data/likes.js (optional; can be implemented in other data modules)
../data/posts.js
../routes/
../routes/animals.js
../routes/index.js
../routes/likes.js
../routes/posts.js
../index.js
../package.json
```

I also recommend having your database settings centralized in files, such as:

```
./
../data/
../data/connection.js
../data/collections.js
```

## Database Structure

You will use a database with the following structure:

- The database will be called **FirstName_LastName_lab7**
- The collection you use to store animals will be called `animals`
- The collection you use to store posts will be called `posts`

### animals

The schema for animals is now as followed:

```javascript
{
	"_id": "", //STRING OR OBJECT ID
	"name": "",
	"animalType": "",
	"likes": [] // Array of strings or Object IDs
}
```

The **\_id** field will be automatically generated by MongoDB, so you do not need to provide it.

An example of this, for Mortimer the Giraffe:

```javascript
{
	"_id": "507f1f77bcf86cd799439011",
	"name": "Mortimer",
	"animalType": "Giraffe",
	"likes": ["a4f8512b9a734baf863ff33ffbabab2d"]
}
```

### posts

The schema for posts is now as followed:

```javascript
{
	"_id": "", //STRING OR OBJECT ID
	"title": "", // String title
	"author": "", // STRING OR OBJECT ID
	"content": "" // String
}
```

The **\_id** field will be automatically generated by MongoDB, so you do not need to provide it.

An example of this, for a post made by Mortimer the Giraffe:

```javascript
{
	"_id": "a4f8512b9a734baf863ff33ffbabab2d",
	"title": "Don't ask me how the weather is up here",
	"author": "507f1f77bcf86cd799439011",
	"content": "It's only like a few feet higher than you. The weather isn't different. Stop harassing me."
}
```

## data/animals.js

In animals.js, you will create and export the same methods as lab 4. You must now account for **liking** a post and **unliking** a post, as well.

## data/posts.js

You will create and export the required methods to perform Create, Read, Update, and Delete methods on the posts structures.

## routes/animals.js

### `GET /animals`

Getting this route will return a list of all animals in the system.

When printing an animal over a route, the animal will be in the following structure:

```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "Mortimer",
  "animalType": "Giraffe",
  "likes": [
    {
      "_id": "a4f8512b9a734baf863ff33ffbabab2d",
      "title": "Don't ask me how the weather is up here"
    }
  ],
  "posts": [
    {
      "_id": "a4f8512b9a734baf863ff33ffbabab2d",
      "title": "Don't ask me how the weather is up here"
    }
  ]
}
```

Rather than showing just the `_id` of the like, you will show the `_id` and `title` for each post they like. You will also show the same thing for each post that this animal writes.

### `POST /animals`

You should expect the following JSON to be submitted:

```json
{
  "name": "Mortimer",
  "animalType": "Giraffe"
}
```

If the JSON provided does not match that schema, you will issue a 400 status code and end the request.

If the JSON is valid and the animal can be created successfull, you will return the newly created animal with a 200 status code. **Remember, when accessing animals via the API, their posts are included**

```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "Mortimer",
  "animalType": "Giraffe",
  "likes": [],
  "posts": []
}
```

### `GET /animals/{id}`

Example: `GET /animals/507f1f77bcf86cd799439011`

If no animal with that `_id` is found, you will issue a 404 status code and end the request.

You will return the animal with a 200 status code. **Remember, when accessing animals via the API, their posts are included**

```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "Mortimer",
  "animalType": "Giraffe",
  "likes": [
    {
      "_id": "a4f8512b9a734baf863ff33ffbabab2d",
      "title": "Don't ask me how the weather is up here"
    }
  ],
  "posts": [
    {
      "_id": "a4f8512b9a734baf863ff33ffbabab2d",
      "title": "Don't ask me how the weather is up here"
    }
  ]
}
```

### `PUT /animals/{id}`

Example: `PUT /animals/507f1f77bcf86cd799439011`

This request will update an animal with information provided from the PUT body.

You should expect the following JSON to be submitted:

```json
{
  "newName": "new name",
  "newType": "new animal type"
}
```

For example:

```json
{
  "newName": "Maximums",
  "newType": "Noble Giraffe"
}
```

**Only one of those fields is required; you may submit this request with either newName, newType, or both!**

If the JSON provided in the PUT body is not as stated above, fail the request with a 400 error and end the request.

If no animals exist with an `_id` of `{id}`, return a 404 and end the request.

### `DELETE /animals/{id}`

Example: `DELETE /animals/507f1f77bcf86cd799439011`

If no animals exist with an `_id` of `{id}`, return a 404 and end the request.

This route will DELETE the animal with the provided `id` **and all posts written by this animal**. Upon deletion, you will return the following structure:

```json
{
  "deleted": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "Mortimer",
    "animalType": "Giraffe",
    "likes": [
      {
        "_id": "a4f8512b9a734baf863ff33ffbabab2d",
        "title": "Don't ask me how the weather is up here"
      }
    ],
    "posts": [
      {
        "_id": "a4f8512b9a734baf863ff33ffbabab2d",
        "title": "Don't ask me how the weather is up here"
      }
    ]
  }
}
```

## routes/posts.js

### `GET /posts`

Getting this route will return a list of all posts in the system

When printing a post over a route, the post will be in the following structure:

```json
{
  "_id": "a4f8512b9a734baf863ff33ffbabab2d",
  "title": "Don't ask me how the weather is up here",
  "content": "It's only like a few feet higher than you. The weather isn't different. Stop harassing me.",
  "author": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "Mortimer"
  }
}
```

Rather than showing just the `_id` of the author, you will show the `_id` and `name` of the author, as seen above.

### `POST /posts`

You should expect the following JSON to be submitted:

```json
{
  "title": "", // String title
  "author": "", // STRING OR OBJECT ID
  "content": "" // String
}
```

If the JSON provided does not match that schema, you will issue a 400 status code and end the request.

If the JSON is valid and the animal can be created successfull, you will return the newly created post with a 200 status code. **Remember, when accessing posts via the API, their author's name is included as well**

```json
{
  "_id": "a4f8512b9a734baf863ff33ffbabab2d",
  "title": "Don't ask me how the weather is up here",
  "content": "It's only like a few feet higher than you. The weather isn't different. Stop harassing me.",
  "author": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "Mortimer"
  }
}
```

### `GET /posts/{id}`

Example: `GET /posts/a4f8512b9a734baf863ff33ffbabab2d`

If no post with that `_id` is found, you will issue a 404 status code and end the request.

You will return the post with a 200 status code. **Remember, when accessing posts via the API, their author's name is include as well.**

```json
{
  "_id": "a4f8512b9a734baf863ff33ffbabab2d",
  "title": "Don't ask me how the weather is up here",
  "content": "It's only like a few feet higher than you. The weather isn't different. Stop harassing me.",
  "author": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "Mortimer"
  }
}
```

### `PUT /posts/{id}`

Example: `PUT /posts/a4f8512b9a734baf863ff33ffbabab2d`

This request will update a post with information provided from the PUT body.

You should expect the following JSON to be submitted:

```json
{
	"newTitle": "new title",
	"newContent: "The new content of the post"
}
```

For example:

```json
{
	"newContent: "I've been sad lately, because people keep asking me how the weather is up high. It's lonely up here."
}
```

Would result in:

```json
{
  "_id": "a4f8512b9a734baf863ff33ffbabab2d",
  "title": "Don't ask me how the weather is up here",
  "content": "I've been sad lately, because people keep asking me how the weather is up high. It's lonely up here.",
  "author": {
    "_id": "507f1f77bcf86cd799439011",
    "name": "Mortimer"
  }
}
```

**Only one of those fields is required; you may submit this request with either newTitle, newContent, or both!**

If the JSON provided in the PUT body is not as stated above, fail the request with a 400 error and end the request.

If no posts exist with an `_id` of `{id}`, return a 404 and end the request.

### `DELETE /posts/{id}`

Example: `DELETE /posts/a4f8512b9a734baf863ff33ffbabab2d`

If no posts exist with an `_id` of `{id}`, return a 404 and end the request.

This route will DELETE the post with the provided `id`. Upon deletion, you will return the following structure:

```json
{
  "deleted": true,
  "data": {
    "_id": "a4f8512b9a734baf863ff33ffbabab2d",
    "title": "Don't ask me how the weather is up here",
    "content": "It's only like a few feet higher than you. The weather isn't different. Stop harassing me.",
    "author": {
      "_id": "507f1f77bcf86cd799439011",
      "name": "Mortimer"
    }
  }
}
```

## routes/likes.js

**Because these were accidentally left out when posting, these routes are extra credit**

### `POST /likes/{animalId}?postId={postId}`

Example: `POST /likes/507f1f77bcf86cd799439011?postId=a4f8512b9a734baf863ff33ffbabab2d`

If no animal exist with an `_id` of `{animalId}`, return a 404 status code and end the request.

If no posts exist with an `_id` of `{postId}`, return a 404 status code and end the request.

This route will add the `postId` provided to the animal's `like` list, and will return a 200 status code if this is successful; no response body will be returned.

If the `postId` is already in the animal's `like` list, simply return a 200 status code

### `DELETE /likes/{animalId}?postId={postId}`

Example: `DELETE /likes/507f1f77bcf86cd799439011?postId=a4f8512b9a734baf863ff33ffbabab2d`

If no animal exist with an `_id` of `{animalId}`, return a 404 status code and end the request.

If no posts exist with an `_id` of `{postId}`, return a 404 status code and end the request.

This route will remove the `postId` provided to the animal's `like` list, and will return a 200 status code if this is successful; no response body will be returned.

If the `postId` is not in the animal's `like` list, simply return a 200 status code

## index.js

Your index.js file will start the express server on **port 3000**, and will print a message to the terminal once the server is strated.

## General Requirements

1. You **must not submit** your node_modules folder
2. You **must remember** to save your dependencies to your package.json folder
3. You must do basic error checking in each function
4. Check for arguments existing and of proper type.
5. Throw if anything is out of bounds (ie, trying to perform an incalculable math operation or accessing data that does not exist)
6. If a function should return a promise, you should mark the method as an `async` function and return the value. Any promises you use inside of that, you should _await_ to get their result values. If the promise should throw, then you should throw inside of that promise in order to return a rejected promise automatically. Thrown exceptions will bubble up from any awaited call that throws as well, unless they are caught in the async method.
7. You **must remember** to update your package.json file to set `index.js` as your starting script!
8. You **must** submit a zip file named in the following format: `LastName_FirstName_CS546_SECTION.zip`
